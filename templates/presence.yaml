####################################################
#                                                                                                    
#            Number of People Home                                                         
#                                                                                                    
####################################################


  - sensor:
      - name: n people home
        state: >
          {{ expand('group.family_presence')|selectattr('state','equalto','on')|list|length +
            (1 if is_state('input_boolean.guest_mode','on') else 0) }}
        icon: >
         {% if is_state("sensor.n_people_home", "0") %} mdi:account-off
         {% elif is_state("sensor.n_people_home", "1") %} mdi:account
         {% elif is_state("sensor.n_people_home", "2") %} mdi:account-multiple
         {% elif is_state("sensor.n_people_home", "3") %} mdi:account-group         
         {% else %} mdi:account-plus {% endif %}

      - name: Guest Mode
        state: >
          {% if is_state("input_boolean.guest_mode", "off") %}No{% else %}Yes{% endif %}
        icon: >
          {% if is_state("input_boolean.guest_mode", "off") %}mdi:account-off{% else %}mdi:account-plus{% endif %}

      - name: duc location
        state: >
          {% set person = states('person.duc') %}
          {% if person in ['iida','tobu','matsumoto'] %}
            grocery store
          {% elif person in ['ario','aeon','lalaport'] %}
            mall            
          {% elif person in ['mcdonalds','kfc','mos'] %}
            lunch takeout
          {% elif person in ['parents','yuri'] %}
            relatives
          {% else %}
            {% if person in ['not_home'] %}
              away
            {% else %}
              {{ states('person.duc') }}
            {%- endif %}
          {%- endif %}

      - name: eri location
        state: >
          {% set person = states('person.eri') %}
          {% if person in ['iida','tobu','matsumoto'] %}
            grocery store
          {% elif person in ['ario','aeon','lalaport'] %}
            mall            
          {% elif person in ['mcdonalds','kfc','mos'] %}
            lunch takeout
          {% elif person in ['parents','yuri'] %}
            relatives
          {% else %}
            {% if person in ['not_home'] %}
              away
            {% else %}
              {{ states('person.eri') }}
            {%- endif %}
          {%- endif %}

      - name: shion location
        state: >
          {% set person = states('person.shion') %}
          {% if person in ['iida','tobu','matsumoto'] %}
            grocery store
          {% elif person in ['ario','aeon','lalaport'] %}
            mall            
          {% elif person in ['mcdonalds','kfc','mos'] %}
            lunch takeout
          {% elif person in ['parents','yuri'] %}
            relatives
          {% else %}
            {% if person in ['not_home'] %}
              away
            {% else %}
              {{ states('person.shion') }}
            {%- endif %}
          {%- endif %}


#########################################################
#
#            PRESENCE DETECTION [GEO/BLE], ROOM HUMAN PRESENCE
#
#########################################################

  - binary_sensor:
      - name: duc presence
        state: "{{ is_state('input_boolean.duc_presence', 'on') }}"

      - name: duc presence alone
        state: "{{ is_state('binary_sensor.eri_presence', 'off') and is_state('binary_sensor.shion_presence', 'off') and is_state('device_tracker.id', 'home' ) }}"

      - name: eri presence
        state: "{{ is_state('input_boolean.eri_presence', 'on') }}"

      - name: shion presence
        state: "{{ is_state('input_boolean.shion_presence', 'on') }}"

      - name: sachiko presence
        state: "{{ is_state('input_boolean.sachiko_presence', 'on') }}"

      - name: tomokun presence
        state: "{{ is_state('input_boolean.tomokun_presence', 'on') }}"


      - name: mr occupancy lights
        state: >
          {% if is_state('binary_sensor.mr_still_target', 'on') and
                 is_state('input_boolean.masterroom_mcl', 'off') %} on
          {% elif is_state('input_boolean.masterroom_mcl', 'on') %} on
          {% else %} off
          {% endif %}

      - name: sr occupancy lights
        state: >
          {% if is_state('binary_sensor.sr_still_target', 'on') or 
                   is_state('binary_sensor.sr_has_still_target', 'on') and
                   is_state('input_boolean.shionroom_mcl', 'off') %} on
          {% elif is_state('input_boolean.shionroom_mcl', 'on') %} on
          {% elif is_state('binary_sensor.sr_study_occupancy', 'on') %} on
          {% else %} off
          {% endif %}


      - name: motion sr auto on
        state: >
          {% set w = states('sensor.date_weekday') %}
          {% set h = states('calendar.holidays_in_japan') %}
          {% set end = '19:59:00' %}
          {% if w == 'on' and h == 'off' %} 
            {{ '06:59:00' < states('sensor.time') < end }}
          {% else %}
            {{ '09:29:00' < states('sensor.time') < end }}
          {% endif %}


####################################################
#                                                                                                    
#            END OF CONFIGURATION FILE                                                 
#                                                                                                    
####################################################
