###############################################################################
#   @author          :   Duc Su 
#   @date              :   04/20/2025
#   @package        :   Utilities
#   @description    :   Maintenances
###############################################################################


group:
  critical_batteries:
    entities: []


template:
  - sensor:
      - name: Critical Battery Count 
        unique_id: critical_battery_count
        state: >
          {{ expand('group.critical_batteries') 
          | rejectattr('state', 'eq', '100')
          | selectattr('state', 'lt', '30') | list | count }}
    
# TESTING
  - binary_sensor:
      - name: wash_occupied
        unique_id: wash_occupied
        icon: mdi:account-group
        state: >
          {{ (states.binary_sensor | 
                 selectattr('entity_id', 'in', area_entities('Wash Room')) |
                 rejectattr('attributes.device_class', 'undefined') |
                 selectattr('attributes.device_class', 'search', '(occupancy|motion|door)') | 
                 selectattr('state', 'eq', 'on') |
                 map(attribute='entity_id') |
                 list | count > 0) }}






script:
  update_critical_battery_group:
    sequence:
      # Reset group 
      - service: group.set
        data:
          object_id: "critical_batteries"
          entities: []
      # Add Battery in the Critical Battery Group
      - service: group.set
        data:
          object_id: "critical_batteries"
          add_entities: >-
            {{ states.sensor | 
              selectattr('entity_id', 'in', area_entities('Critical Batteries')) |
              map(attribute='entity_id') | list  | join(',') }} 
